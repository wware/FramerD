#!@prefix@/bin/fdscript noherald=1
;; -*- Mode: fdscript -*-

(define (convert-args arglist)
  (let ((option-stream (open-string-stream))
	(filename-stream (open-string-stream)))
    (dolist (arg arglist)
      (cond ((eqv? (elt arg 0) #\-)
	     (display elt option-stream)
	     (display " " option-stream))
	    (else (display elt filename-stream)
		  (display " " filename-stream))))
    (cons (string-stream-contents option-stream)
	  (string-stream-contents filename-stream))))

(define (compile-command)
  (let ((output-file arg2)
	(compile-args (convert-args (cdr (cdr args)))))
    (system "ld -shared -o " output-file " -L@prefix@/lib "
	    (car compile-args) " " (cdr compile-args)
	    "-ldtypes -lframerd -lfdscript -lfdtext -lfdwww")))

(define (install-command)
  (let* ((install-file arg2)
	 (dest (stringout framerd_lib "/modules/" install-file))
	 (group (if (and (getenv "FRAMERD_GROUP")
			 (get-gid (getenv "FRAMERD_GROUP")))
		    (getenv "FRAMERD_GROUP")
		    (and (get-gid "framerd") "framerd"))))
    (if (has-suffix arg2 ".fdx") (copy-text-file arg2 dest)
	(copy-binary-file arg2 dest))
    (when group
      (system "chgrp " group " " dest)
      (system "chmod g+rw " dest))))

(define (main)
  (cond ((or (equal? arg1 "-c") (equal? arg1 "compile"))
	 (compile-command))
	((or (equal? arg1 "-i") (equal? arg1 "install"))
	 (install-command))
	((equal? arg1 "cflags")
	 (lineout "@extra_cc_flags@ @CFLAGS@ -I@prefix@/include"))
	((equal? arg1 "ldflags")	    
	 (lineout "@LDFLAGS@ @LIBS@"))
	((equal? arg1 "libs")	    
	 (lineout "-L@prefix@/lib -ldtypes -lframerd -lfdscript -lfdtext -lfdwww"))
	((equal? arg1 "module_suffix")
	 (lineout "@shared_lib_suffix@"))
	((equal? arg1 "modules")
	 (lineout "@prefix@/share/framerd/modules"))
	((equal? arg1 "cmodules")
	 (lineout "@prefix@/share/framerd/lib"))
	((equal? arg1 "includedir")
	 (lineout "@prefix@/include/framerd"))
	((equal? arg1 "libdir")
	 (lineout "@prefix@/lib"))
	((equal? arg1 "deps")
	 (lineout "@prefix@/include/framerd/config.h @prefix@/lib/@bin_dep_file@"))))

